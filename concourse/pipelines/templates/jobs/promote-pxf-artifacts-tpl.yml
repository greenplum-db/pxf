{% set name = 'promote-pxf-for-gp5-gp6-gp7-artifacts' %}
{% set job_names.all = job_names.all + [name] %}
- name: [[name]]
  plan:
  - in_parallel:
    - get: pxf_src
      resource: pxf-src
      trigger: true
      passed: [[job_names.backward_compatibility]]
{% call(x) macros.for_each_config(build_test_pxf_combinations) %}
    {% if x.build_platform == x.test_platform %}
    {% if x.test_os != 'oel' %}
    - get: pxf_gp[[x.gp_ver]]_tarball_[[x.release_platform]]
      resource: pxf-gp[[x.gp_ver]]-tarball-[[x.release_platform]]
      passed: [[job_names.resources['pxf-gp' ~x .gp_ver~'-tarball-'~x.test_platform]]]
    {% endif %}
    {% endif %}
{% endcall %}
    - get: google-cloud-sdk-slim-image
  - task: [[name]]
    image: google-cloud-sdk-slim-image
    params:
      ENVIRONMENT: [[ environment ]]
      GCS_RELEASES_BUCKET: ((ud/pxf/common/releases-bucket-name))
      GCS_RELEASES_PATH: [[ environment ]]/releases
      GIT_BRANCH: ((pxf-git-branch))
      GIT_EMAIL: ((ud/pxf/common/git-deploy-email))
      GIT_REMOTE_URL: ((ud/pxf/[[ environment ]]/git-remote-ssh-url))
      GIT_SSH_KEY: ((ud/pxf/secrets/git-deploy-key))
      GIT_USERNAME: ((ud/pxf/common/git-deploy-username))
      GOOGLE_CREDENTIALS: ((ud/pxf/secrets/pxf-storage-service-account-key))
    config:
      inputs:
        - name: pxf_src
{% call(x) macros.for_each_config(build_test_pxf_combinations) %}
    {% if x.build_platform == x.test_platform %}
    {% if x.test_os != 'oel' %}
        - name: pxf_gp[[x.gp_ver]]_tarball_[[x.release_platform]]
    {% endif %}
    {% endif %}
{% endcall %}
      platform: linux
      run:
        path: pxf_src/concourse/scripts/promote_pxf_artifacts.bash
{% if slack_notification %}
    <<: *slack_alert
{% endif %}
