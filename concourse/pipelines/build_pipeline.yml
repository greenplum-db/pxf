---
## ======================================================================
## RESOURCE TYPES
## ======================================================================
resource_types:
- name: gcs
  type: docker-image
  source:
    repository: frodenas/gcs-resource

## ======================================================================
## RESOURCES
## ======================================================================
resources:

## ---------- Github Repos ----------
- name: pxf_src
  type: git
  icon: git
  source:
    branch: ((pxf-git-branch))
    uri: ((pxf-git-remote))

## ---------- Docker Images ----------
- name: gpdb-pxf-dev-centos6-image
  type: docker-image
  icon: docker
  source:
    repository: pivotaldata/gpdb-pxf-dev
    tag: centos6

- name: gpdb-pxf-dev-centos7-image
  type: docker-image
  icon: docker
  source:
    repository: pivotaldata/gpdb-pxf-dev
    tag: centos7

- name: gpdb-pxf-dev-ubuntu18-image
  type: docker-image
  icon: docker
  source:
    repository: pivotaldata/gpdb-pxf-dev
    tag: ubuntu18

- name: gpdb-pxf-dev-centos6-hdp2-server-image
  type: docker-image
  icon: docker
  source:
    repository: pivotaldata/gpdb-pxf-dev
    tag: centos6-hdp2-server

- name: gpdb-pxf-dev-centos7-hdp2-server-image
  type: docker-image
  icon: docker
  source:
    repository: pivotaldata/gpdb-pxf-dev
    tag: centos7-hdp2-server

- name: gpdb-pxf-dev-ubuntu18-hdp2-server-image
  type: docker-image
  icon: docker
  source:
    repository: pivotaldata/gpdb-pxf-dev
    tag: ubuntu18-hdp2-server

- name: gpdb-pxf-dev-centos7-mapr-server-image
  type: docker-image
  icon: docker
  source:
    repository: pivotaldata/gpdb-pxf-dev
    tag: centos7-mapr-server

- name: gpdb-pxf-dev-centos7-hdp3-server-image
  type: docker-image
  icon: docker
  source:
    repository: pivotaldata/gpdb-pxf-dev
    tag: centos7-hdp3-server

- name: gpdb-pxf-dev-centos7-cdh-server-image
  type: docker-image
  icon: docker
  source:
    repository: pivotaldata/gpdb-pxf-dev
    tag: centos7-cdh-server

## ---------- Product Packages ----------
- name: gpdb_rhel6_rpm
  type: gcs
  icon: google-drive
  source:
    bucket: data-gpdb-ud-pivnet-artifacts
    json_key: ((data-gpdb-ud-google-json-key))
    regexp: latest/greenplum-db-(.*)-rhel6-x86_64.rpm

- name: gpdb_rhel7_rpm
  type: gcs
  icon: google-drive
  source:
    bucket: data-gpdb-ud-pivnet-artifacts
    json_key: ((data-gpdb-ud-google-json-key))
    regexp: latest/greenplum-db-(.*)-rhel7-x86_64.rpm

- name: gpdb_ubuntu18_deb
  type: gcs
  icon: google-drive
  source:
    bucket: data-gpdb-ud-pivnet-artifacts
    json_key: ((data-gpdb-ud-google-json-key))
    regexp: latest/greenplum-db-(.*)-ubuntu18.04-amd64.deb

## ---------- PXF Build Artifacts ----------
- name: pxf_tarball_gpdb6_rhel6
  type: gcs
  icon: google-drive
  source:
    bucket: data-gpdb-ud-pxf-build
    json_key: ((data-gpdb-ud-google-json-key))
    versioned_file: prod/snapshots/pxf-gpdb6-SNAPSHOT-rhel6-x86_64.tar.gz

- name: pxf_tarball_gpdb6_rhel7
  type: gcs
  icon: google-drive
  source:
    bucket: data-gpdb-ud-pxf-build
    json_key: ((data-gpdb-ud-google-json-key))
    versioned_file: prod/snapshots/pxf-gpdb6-SNAPSHOT-rhel7-x86_64.tar.gz

- name: pxf_tarball_gpdb6_ubuntu18
  type: gcs
  icon: google-drive
  source:
    bucket: data-gpdb-ud-pxf-build
    json_key: ((data-gpdb-ud-google-json-key))
    versioned_file: prod/snapshots/pxf-gpdb6-SNAPSHOT-ubuntu18.04-x86_64.tar.gz

## ======================================================================
## JOBS
## ======================================================================

## ---------- Centos 6 Swimlane ----------
jobs:
- name: Build PXF-GP6 on RHEL6
  plan:
  - in_parallel:
    - get: pxf_src
      trigger: true
    - get: gpdb_package
      resource: gpdb_rhel6_rpm
    - get: gpdb-pxf-dev-centos6-image
  - task: Build PXF on RHEL6
    image: gpdb-pxf-dev-centos6-image
    file: pxf_src/concourse/tasks/build.yml
    params:
      TARGET_OS: rhel6
  - put: pxf_tarball_gpdb6_rhel6
    params:
      file: dist/pxf-gpdb6-*-SNAPSHOT-rhel6-x86_64.tar.gz

- name: Test PXF-GP6-HDP2 on RHEL6
  plan:
  - in_parallel:
    - get: pxf_src
      passed: [Build PXF-GP6 on RHEL6]
      trigger: true
    - get: pxf_tarball
      resource: pxf_tarball_gpdb6_rhel6
      passed: [Build PXF-GP6 on RHEL6]
    - get: gpdb_package
      resource: gpdb_rhel6_rpm
      passed: [Build PXF-GP6 on RHEL6]
    - get: gpdb-pxf-dev-centos6-hdp2-server-image
  - task: Test PXF-GP6-HDP2 on RHEL6
    file: pxf_src/concourse/tasks/test.yml
    image: gpdb-pxf-dev-centos6-hdp2-server-image
    params:
      ACCESS_KEY_ID: ((tf-machine-access-key-id))
      GROUP: gpdb,proxy,profile
      SECRET_ACCESS_KEY: ((tf-machine-secret-access-key))
      TARGET_OS: centos
      TARGET_OS_VERSION: 6
#      TEST_ENV: ((test-env))

## ---------- Centos 7 Swimlane ----------
- name: Build PXF-GP6 on RHEL7
  plan:
  - in_parallel:
    - get: pxf_src
      trigger: true
    - get: gpdb_package
      resource: gpdb_rhel7_rpm
    - get: gpdb-pxf-dev-centos7-image
  - task: Build PXF-GP6 on RHEL7
    image: gpdb-pxf-dev-centos7-image
    file: pxf_src/concourse/tasks/build.yml
    params:
      TARGET_OS: rhel7
  - put: pxf_tarball_gpdb6_rhel7
    params:
      file: dist/pxf-gpdb6-*-SNAPSHOT-rhel7-x86_64.tar.gz

- name: Test PXF-GP6-HDP2 on RHEL7
  plan:
  - in_parallel:
    - get: pxf_src
      passed: [Build PXF-GP6 on RHEL7]
      trigger: true
    - get: pxf_tarball
      resource: pxf_tarball_gpdb6_rhel7
      passed: [Build PXF-GP6 on RHEL7]
    - get: gpdb_package
      resource: gpdb_rhel7_rpm
      passed: [Build PXF-GP6 on RHEL7]
    - get: gpdb-pxf-dev-centos7-hdp2-server-image
  - task: Test PXF-GP6-HDP2 on RHEL7
    file: pxf_src/concourse/tasks/test.yml
    image: gpdb-pxf-dev-centos7-hdp2-server-image
    params:
      ACCESS_KEY_ID: ((tf-machine-access-key-id))
      GROUP: gpdb,proxy,profile
      SECRET_ACCESS_KEY: ((tf-machine-secret-access-key))
      TARGET_OS: centos
      TARGET_OS_VERSION: 7
#      TEST_ENV: ((test-env))

## ---------- Ubuntu 18 Swimlane ----------
- name: Build PXF-GP6 on Ubuntu18
  plan:
  - in_parallel:
    - get: pxf_src
      trigger: true
    - get: gpdb_package
      resource: gpdb_ubuntu18_deb
    - get: gpdb-pxf-dev-ubuntu18-image
  - task: Build PXF-GP6 on Ubuntu18
    image: gpdb-pxf-dev-ubuntu18-image
    file: pxf_src/concourse/tasks/build.yml
    params:
      TARGET_OS: ubuntu18.04
  - put: pxf_tarball_gpdb6_ubuntu18
    params:
      file: dist/pxf-gpdb6-*-SNAPSHOT-ubuntu18.04-x86_64.tar.gz

- name: Test PXF-GP6-HDP2 on Ubuntu18
  plan:
  - in_parallel:
    - get: pxf_src
      passed: [Build PXF-GP6 on Ubuntu18]
      trigger: true
    - get: pxf_tarball
      resource: pxf_tarball_gpdb6_ubuntu18
      passed: [Build PXF-GP6 on Ubuntu18]
    - get: gpdb_package
      resource: gpdb_ubuntu18_deb
      passed: [Build PXF-GP6 on Ubuntu18]
    - get: gpdb-pxf-dev-ubuntu18-hdp2-server-image
  - task: Test PXF-GP6-HDP2 on Ubuntu18
    file: pxf_src/concourse/tasks/test.yml
    image: gpdb-pxf-dev-ubuntu18-hdp2-server-image
    params:
      ACCESS_KEY_ID: ((tf-machine-access-key-id))
      GROUP: gpdb,proxy,profile
      SECRET_ACCESS_KEY: ((tf-machine-secret-access-key))
      TARGET_OS: ubuntu
      TARGET_OS_VERSION: 18
#      TEST_ENV: ((test-env))

## ---------- Testing Gate ----------
- name: Testing Gate for PXF-GP6
  plan:
  - in_parallel:
    # pxf source passed all testing jobs
    - get: pxf_src
      passed:
      - Test PXF-GP6-HDP2 on RHEL6
      - Test PXF-GP6-HDP2 on RHEL7
      - Test PXF-GP6-HDP2 on Ubuntu18
      trigger: true
    # pxf tarballs passed testing jobs
    - get: pxf_tarball_gpdb6_rhel6
      passed:
      - Test PXF-GP6-HDP2 on RHEL6
    - get: pxf_tarball_gpdb6_rhel7
      passed:
      - Test PXF-GP6-HDP2 on RHEL7
    - get: pxf_tarball_gpdb6_ubuntu18
      passed:
      - Test PXF-GP6-HDP2 on Ubuntu18
    # gpdb packages used in testing jobs
    - get: gpdb_rhel6_rpm
      passed:
      - Test PXF-GP6-HDP2 on RHEL6
    - get: gpdb_rhel7_rpm
      passed:
      - Test PXF-GP6-HDP2 on RHEL7
    - get: gpdb_ubuntu18_deb
      passed:
      - Test PXF-GP6-HDP2 on Ubuntu18

## ---------- Extended Tests ----------
- name: Test PXF-GP6-MAPR on RHEL7
  plan:
  - in_parallel:
    - get: pxf_src
      passed: [Testing Gate for PXF-GP6]
      trigger: true
    - get: pxf_tarball
      resource: pxf_tarball_gpdb6_rhel7
      passed: [Testing Gate for PXF-GP6]
    - get: gpdb_package
      resource: gpdb_rhel7_rpm
      passed: [Testing Gate for PXF-GP6]
    - get: gpdb-pxf-dev-centos7-mapr-server-image
  - task: Test PXF-GP6-MAPR on RHEL7
    privileged: true
    file: pxf_src/concourse/tasks/test.yml
    image: gpdb-pxf-dev-centos7-mapr-server-image
    params:
      GROUP: hcfs,jdbc
      HADOOP_CLIENT: MAPR
      TARGET_OS: centos
      TARGET_OS_VERSION: 7
#      TEST_ENV: ((test-env))

- name: Test PXF-GP6-HDP3 on RHEL7
  plan:
  - in_parallel:
    - get: pxf_src
      passed: [Testing Gate for PXF-GP6]
      trigger: true
    - get: pxf_tarball
      resource: pxf_tarball_gpdb6_rhel7
      passed: [Testing Gate for PXF-GP6]
    - get: gpdb_package
      resource: gpdb_rhel7_rpm
      passed: [Testing Gate for PXF-GP6]
    - get: gpdb-pxf-dev-centos7-hdp3-server-image
  - task: Test PXF-GP6-HDP3 on RHEL7
    file: pxf_src/concourse/tasks/test.yml
    image: gpdb-pxf-dev-centos7-hdp3-server-image
    params:
      ACCESS_KEY_ID: ((tf-machine-access-key-id))
      GROUP: gpdb,proxy,profile
      SECRET_ACCESS_KEY: ((tf-machine-secret-access-key))
      TARGET_OS: centos
      TARGET_OS_VERSION: 7
#      TEST_ENV: ((test-env))

- name: Test PXF-GP6-HDP2-JDK11 on RHEL7
  plan:
  - in_parallel:
    - get: pxf_src
      passed: [Testing Gate for PXF-GP6]
      trigger: true
    - get: pxf_tarball
      resource: pxf_tarball_gpdb6_rhel7
      passed: [Testing Gate for PXF-GP6]
    - get: gpdb_package
      resource: gpdb_rhel7_rpm
      passed: [Testing Gate for PXF-GP6]
    - get: gpdb-pxf-dev-centos7-hdp2-server-image
  - task: Test PXF-GP6-HDP2-JDK11 on RHEL7
    file: pxf_src/concourse/tasks/test.yml
    image: gpdb-pxf-dev-centos7-hdp2-server-image
    params:
      ACCESS_KEY_ID: ((tf-machine-access-key-id))
      GROUP: cloud-access-and-hdfs,hbase,hcfs,jdbc,profile,pushdown
      RUN_JDK_VERSION: 11
      SECRET_ACCESS_KEY: ((tf-machine-secret-access-key))
      TARGET_OS: centos
      TARGET_OS_VERSION: 7
#      TEST_ENV: ((test-env))

- name: Test PXF-GP6-CDH on RHEL7
  plan:
  - in_parallel:
    - get: pxf_src
      passed: [Testing Gate for PXF-GP6]
      trigger: true
    - get: pxf_tarball
      resource: pxf_tarball_gpdb6_rhel7
      passed: [Testing Gate for PXF-GP6]
    - get: gpdb_package
      resource: gpdb_rhel7_rpm
      passed: [Testing Gate for PXF-GP6]
    - get: gpdb-pxf-dev-centos7-cdh-server-image
  - task: Test PXF-GP6-CDH on RHEL7
    file: pxf_src/concourse/tasks/test.yml
    image: gpdb-pxf-dev-centos7-cdh-server-image
    attempts: 2
    params:
      ACCESS_KEY_ID: ((tf-machine-access-key-id))
      GROUP: gpdb,proxy,profile
      HADOOP_CLIENT: CDH
      SECRET_ACCESS_KEY: ((tf-machine-secret-access-key))
      TARGET_OS: centos
      TARGET_OS_VERSION: 7
#      TEST_ENV: ((test-env))

- name: Test PXF-GP6-CDH-S3-NO-IMPERS on RHEL7
  plan:
  - in_parallel:
    - get: pxf_src
      passed: [Testing Gate for PXF-GP6]
      trigger: true
    - get: pxf_tarball
      resource: pxf_tarball_gpdb6_rhel7
      passed: [Testing Gate for PXF-GP6]
    - get: gpdb_package
      resource: gpdb_rhel7_rpm
      passed: [Testing Gate for PXF-GP6]
    - get: gpdb-pxf-dev-centos7-cdh-server-image
  - task: Test PXF-GP6-CDH-S3-NO-IMPERS on RHEL7
    file: pxf_src/concourse/tasks/test.yml
    image: gpdb-pxf-dev-centos7-cdh-server-image
    params:
      ACCESS_KEY_ID: ((tf-machine-access-key-id))
      GROUP: hcfs,s3
      HADOOP_CLIENT: CDH
      IMPERSONATION: false
      PROTOCOL: s3
      SECRET_ACCESS_KEY: ((tf-machine-secret-access-key))
      TARGET_OS: centos
      TARGET_OS_VERSION: 7
#      TEST_ENV: ((test-env))
      TEST_OS: centos

- name: Test PXF-GP6-HDP2-S3-IMPERS on RHEL7
  plan:
  - in_parallel:
    - get: pxf_src
      passed: [Testing Gate for PXF-GP6]
      trigger: true
    - get: pxf_tarball
      resource: pxf_tarball_gpdb6_rhel7
      passed: [Testing Gate for PXF-GP6]
    - get: gpdb_package
      resource: gpdb_rhel7_rpm
      passed: [Testing Gate for PXF-GP6]
    - get: gpdb-pxf-dev-centos7-hdp2-server-image
  - task: Test PXF-GP6-HDP2-S3-IMPERS on RHEL7
    file: pxf_src/concourse/tasks/test.yml
    image: gpdb-pxf-dev-centos7-hdp2-server-image
    params:
      ACCESS_KEY_ID: ((tf-machine-access-key-id))
      GROUP: hcfs,s3
      IMPERSONATION: true
      PROTOCOL: s3
      SECRET_ACCESS_KEY: ((tf-machine-secret-access-key))
      TARGET_OS: centos
      TARGET_OS_VERSION: 7
      #      TEST_ENV: ((test-env))
      TEST_OS: centos

- name: Test PXF-GP6-HDP2-NO-IMPERS on RHEL7
  plan:
  - in_parallel:
    - get: pxf_src
      passed: [Testing Gate for PXF-GP6]
      trigger: true
    - get: pxf_tarball
      resource: pxf_tarball_gpdb6_rhel7
      passed: [Testing Gate for PXF-GP6]
    - get: gpdb_package
      resource: gpdb_rhel7_rpm
      passed: [Testing Gate for PXF-GP6]
    - get: gpdb-pxf-dev-centos7-hdp2-server-image
  - task: Test PXF-GP6-HDP2-NO-IMPERS on RHEL7
    file: pxf_src/concourse/tasks/test.yml
    image: gpdb-pxf-dev-centos7-hdp2-server-image
    params:
      GROUP: smoke
      IMPERSONATION: false
      TARGET_OS: centos
      TARGET_OS_VERSION: 7
#      TEST_ENV: ((test-env))
